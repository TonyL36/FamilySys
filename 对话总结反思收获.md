对话总结反思收获

一、问题背景与目标
1. 远亲关系图出现“称谓反转”，核心规则要求“member1 是 member2 的关系”。
2. 祖孙/外祖父母等方向关系出现错判，且查询时展示与存储方向混淆。
3. 需要在不破坏前端关系展示逻辑的前提下修正后端存储与计算规则。
4. 数据需要可回滚、可对照，避免家族真实数据误同步到远端。

二、具体修改点（文件级）
1. FamilyRelationshipCalculator.java
   - 修正路径边的方向描述匹配逻辑，保证 from→to 的“展示方向”与“存储语义”一致。
   - 避免把“反向展示逻辑”与“存储逻辑”混用导致称谓反转。
2. RelationshipService.java
   - 修复祖孙、外祖父母关系的存储方向，严格遵循 member1 视角关系定义。
   - 对应关系类型对调，确保 member1=祖辈、member2=孙辈时存为“孙子/孙女/外孙/外孙女”。
3. Controller 与数据库加载策略（已在既有改动基础上保持）
   - 保证资源目录优先加载，避免运行时使用错误库。
   - UTF-8 编码处理保持一致，避免中文显示乱码。

三、数据测试方法与步骤
1. 空库重建
   - 清空资源库，重新创建 Members 与 Relationships 表结构。
2. 数据注入顺序
   - 按代际从高到低插入成员。
   - 按“父母→配偶→子女（长次小）”顺序插入关系。
3. 对照数据来源
   - 从 family.backup3.db 读取成员与基础关系（配偶、长次小子/女）。
   - 仅录入最小必要关系，让系统自动生成近亲与远亲关系。
4. 关键用例校验
   - member1=17、member2=51 必须存为“孙子”。
   - 远亲路径计算结果需与存储关系方向一致。

四、验证结果与现状
1. 构建与测试均通过，功能回归一致。
2. 关键关系用例通过：member1=17、member2=51 为“孙子”。
3. 远亲展示方向正常，祖孙/外祖关系不再反转。

五、代码与数据测试优化方向
1. 关系方向校验自动化
   - 增加“反向称谓对照表”的单元测试，覆盖祖孙与外祖方向的双向校验。
2. 数据录入流程稳定化
   - 固化生成脚本流程与录入顺序，减少手动干预。
3. 数据安全控制
   - family.db 明确不进入版本库，仅保留结构与脚本。
4. 前后端一致性校验
   - 关系图展示规则与存储规则写成一致的验收断言。

六、收获与经验（中国家谱场景）
1. 家谱称谓高度依赖方向与性别，任何方向混用都会引发系统性错判。
2. 近亲关系的“生成时机”要稳定，否则远亲计算会继承错误关系。
3. 中国家谱中“父系/母系”差异明显，外祖关系必须与父系关系严格区分。
4. 实践表明：先建立正确的最小基础关系，再让系统推导扩展，效果更稳定。

七、数据同步注意事项
1. 家族真实数据不应进入 Git 远端。
2. 版本库只保留代码与结构，数据通过本地备份或离线导出管理。
