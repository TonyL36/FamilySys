<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家族关系树</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        #tree-container {
            width: 100%;
            height: 800px;
            border: 1px solid #eee;
            margin-top: 20px;
        }

        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        select {
            width: 100%;
            max-width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            padding: 8px 16px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        .error-message {
            color: #dc2626;
            margin-top: 5px;
            font-size: 14px;
        }

        .result-message {
            margin-top: 15px;
            padding: 10px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>家族关系树</h1>
        <div class="controls">
            <div class="form-group">
                <label for="root-member">选择起始成员：</label>
                <select id="root-member"></select>
            </div>
            <div class="form-group">
                <label for="target-member">选择目标成员：</label>
                <select id="target-member"></select>
            </div>
            <button onclick="generateTree()">生成关系树</button>
            <button onclick="queryDistantRelative()">查询远亲关系</button>
        </div>
        <div id="tree-container"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://47.109.193.180:8000';
        const API_KEY = 'YLqWKfriSzxY4p2MTYjXEa63km86v9O6W4LoEOEM8vuXR7leJ9LZSr0g0Dafq_Dw';
        let allMembers = [];
        let allRelationships = [];
        let myChart = null;

        // 通用的 fetch 配置
        const fetchConfig = {
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-API-Key': API_KEY
            },
            mode: 'cors'
        };

        // 初始化图表
        function initChart() {
            if (myChart) {
                myChart.dispose();
            }
            myChart = echarts.init(document.getElementById('tree-container'));
            
            // 设置默认配置
            const option = {
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove'
                },
                series: [
                    {
                        type: 'tree',
                        data: [],
                        top: '5%',
                        left: '20%',
                        bottom: '5%',
                        right: '20%',
                        symbolSize: 10,
                        orient: 'vertical',
                        layout: 'orthogonal',
                        initialTreeDepth: -1,
                        lineStyle: {
                            color: '#2563eb',
                            width: 2,
                            curveness: 0.5
                        },
                        label: {
                            position: 'top',
                            rotate: 0,
                            verticalAlign: 'middle',
                            align: 'middle',
                            fontSize: 14
                        },
                        leaves: {
                            label: {
                                position: 'bottom',
                                verticalAlign: 'middle',
                                align: 'middle'
                            }
                        },
                        emphasis: {
                            focus: 'descendant'
                        },
                        expandAndCollapse: true,
                        animationDuration: 550,
                        animationDurationUpdate: 750
                    }
                ]
            };
            
            myChart.setOption(option);
        }

        // 获取所有成员
        async function loadMembers() {
            try {
                const response = await fetch(`${API_BASE_URL}/member`, {
                    ...fetchConfig,
                    method: 'GET'
                });
                if (!response.ok) throw new Error('Failed to fetch members');
                allMembers = await response.json();
                
                // 填充选择框
                const select = document.getElementById('root-member');
                select.innerHTML = allMembers
                    .map(member => `<option value="${member.id}">${member.name} (ID: ${member.id})</option>`)
                    .join('');
            } catch (error) {
                console.error('Error:', error);
                showError('获取成员列表失败');
            }
        }

        // 获取所有关系
        async function loadRelationships() {
            try {
                const response = await fetch(`${API_BASE_URL}/relationship`, {
                    ...fetchConfig,
                    method: 'GET'
                });
                if (!response.ok) throw new Error('Failed to fetch relationships');
                allRelationships = await response.json();
            } catch (error) {
                console.error('Error:', error);
                showError('获取关系列表失败');
            }
        }

        // 查找成员的所有子女
        function findChildren(memberId) {
            const children = allRelationships
                .filter(rel => 
                    rel.member1ID === memberId && 
                    [5, 6, 7, 8, 9, 10].includes(rel.relationType) // 长子、次子、小子、长女、次女、小女
                )
                .sort((a, b) => a.relationType - b.relationType) // 按照长幼排序
                .map(rel => {
                    const child = allMembers.find(m => m.id === rel.member2ID);
                    return {
                        name: child.name,
                        id: child.id,
                        children: [] // 预留子节点
                    };
                });
            return children;
        }

        // 查找配偶
        function findSpouse(memberId) {
            const spouseRel = allRelationships.find(rel => 
                (rel.member1ID === memberId && [1, 2].includes(rel.relationType)) || // 丈夫、妻子
                (rel.member2ID === memberId && [1, 2].includes(rel.relationType))
            );

            if (spouseRel) {
                const spouseId = spouseRel.member1ID === memberId ? spouseRel.member2ID : spouseRel.member1ID;
                const spouse = allMembers.find(m => m.id === spouseId);
                return {
                    name: spouse.name,
                    id: spouse.id,
                    children: []
                };
            }
            return null;
        }

        // 递归构建树
        function buildFamilyTree(memberId) {
            const member = allMembers.find(m => m.id === memberId);
            if (!member) return null;

            const node = {
                name: member.name,
                id: member.id,
                children: []
            };

            // 查找配偶
            const spouse = findSpouse(memberId);
            if (spouse) {
                node.children.push({
                    name: spouse.name,
                    id: spouse.id,
                    lineStyle: {
                        color: '#e11d48', // 配偶关系用红色线
                        type: 'dashed'
                    }
                });
            }

            // 查找并添加子女
            const children = findChildren(memberId);
            for (const child of children) {
                const childTree = buildFamilyTree(child.id);
                if (childTree) {
                    node.children.push(childTree);
                }
            }

            return node;
        }

        // 生成家族树
        async function generateTree() {
            const rootMemberId = parseInt(document.getElementById('root-member').value);
            if (!rootMemberId) {
                showError('请选择起始成员');
                return;
            }

            // 构建树形数据
            const treeData = buildFamilyTree(rootMemberId);
            if (!treeData) {
                showError('生成家族树失败');
                return;
            }

            // 更新图表
            myChart.setOption({
                series: [{
                    data: [treeData]
                }]
            });
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.controls').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // 显示远亲关系结果
        function showDistantRelativeResult(result) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-message';
            resultDiv.style.marginTop = '15px';
            resultDiv.style.padding = '10px';
            resultDiv.style.background = '#f0f9ff';
            resultDiv.style.border = '1px solid #bae6fd';
            resultDiv.style.borderRadius = '4px';
            
            let content = `<strong>关系结果：</strong> ${result.description}`;
            if (result.preciseKinshipTerm) {
                content += `<br><strong>精确称谓：</strong> ${result.preciseKinshipTerm}`;
            }
            if (result.pathLength > 0) {
                content += `<br><strong>亲缘系数：</strong> ${result.kinshipCoefficient.toFixed(6)}`;
            }
            
            resultDiv.innerHTML = content;
            document.querySelector('.controls').appendChild(resultDiv);
            setTimeout(() => resultDiv.remove(), 5000);
        }

        // 查询远亲关系
        async function queryDistantRelative() {
            const member1Id = parseInt(document.getElementById('root-member').value);
            const member2Id = parseInt(document.getElementById('target-member').value);
            
            if (!member1Id || !member2Id) {
                showError('请选择起始成员和目标成员');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/relationship?distantRelative=1&member1ID=${member1Id}&member2ID=${member2Id}`, {
                    ...fetchConfig,
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error('查询失败');
                }
                
                const result = await response.json();
                showDistantRelativeResult(result);
            } catch (error) {
                showError('查询远亲关系失败: ' + error.message);
            }
        }

        // 页面加载完成后初始化
        window.onload = async function() {
            initChart();
            await loadMembers();
            await loadRelationships();
            
            // 填充目标成员选择框
            const targetSelect = document.getElementById('target-member');
            targetSelect.innerHTML = allMembers
                .map(member => `<option value="${member.id}">${member.name} (ID: ${member.id})</option>`)
                .join('');
            
            // 自适应窗口大小
            window.onresize = function() {
                myChart.resize();
            };
        };
    </script>
</body>
</html>
